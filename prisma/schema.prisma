// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== USER & AUTH ====================
model User {
  id            String   @id @default(uuid())
  email         String   @unique // Must be @ac.id email
  password      String
  fullName      String
  avatar        String?
  faculty       String?
  semester      Int?
  bio           String?
  phoneNumber   String?
  
  role          UserRole @default(CLIENT)
  isVerified    Boolean  @default(false)
  isActive      Boolean  @default(true)
  
  // Verifikasi kampus
  verificationToken String?
  verificationExpiry DateTime?
  
  // Timestamps
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  lastLoginAt   DateTime?
  
  // Relations
  wallet        Wallet?
  servicesOffered Service[] @relation("ServiceProvider")
  ordersAsClient Order[] @relation("ClientOrders")
  ordersAsWorker Order[] @relation("WorkerOrders")
  reviewsGiven   Review[] @relation("ReviewsGiven")
  reviewsReceived Review[] @relation("ReviewsReceived")
  chats         ChatParticipant[]
  notifications Notification[]
  disputes      Dispute[]
  
  @@map("users")
}

enum UserRole {
  CLIENT
  WORKER
  ADMIN
}

// ==================== SERVICES (JASA) ====================
model Service {
  id          String   @id @default(uuid())
  title       String
  slug        String   @unique
  description String
  category    ServiceCategory
  
  // Pricing
  basePrice   Decimal  @db.Decimal(10, 2)
  minPrice    Decimal? @db.Decimal(10, 2)
  maxPrice    Decimal? @db.Decimal(10, 2)
  
  // Details
  deliveryDays Int     // Estimasi hari pengerjaan
  revisions    Int     @default(1)
  
  // Media
  images      String[] // Array of image URLs
  portfolioFiles String[] // Portfolio attachments
  
  // Status
  isActive    Boolean  @default(true)
  isApproved  Boolean  @default(false) // Admin approval
  
  // Stats (denormalized for performance)
  totalOrders Int      @default(0)
  averageRating Decimal? @db.Decimal(3, 2)
  
  // Relations
  providerId  String
  provider    User     @relation("ServiceProvider", fields: [providerId], references: [id], onDelete: Cascade)
  
  orders      Order[]
  reviews     Review[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([category])
  @@index([providerId])
  @@index([averageRating])
  @@map("services")
}

enum ServiceCategory {
  DATA_ANALYSIS      // Analisis Data & Statistik
  CODING             // Coding & Aplikasi
  WRITING            // Penulisan Akademik
  DESIGN             // Desain Grafis
  EVENT              // Event & Publikasi
  TUTORING           // Tutor & Bimbingan
  TECHNICIAN         // Teknisi / Jasa Praktis
}

// ==================== ORDERS ====================
model Order {
  id          String   @id @default(uuid())
  orderNumber String   @unique // BAN-2025-XXXXX
  
  // Parties
  clientId    String
  client      User     @relation("ClientOrders", fields: [clientId], references: [id])
  workerId    String
  worker      User     @relation("WorkerOrders", fields: [workerId], references: [id])
  
  serviceId   String
  service     Service  @relation(fields: [serviceId], references: [id])
  
  // Order Details
  description String   // Custom request dari client
  requirements String? // Attachment/link requirements
  
  // Pricing
  agreedPrice Decimal  @db.Decimal(10, 2)
  platformFee Decimal  @db.Decimal(10, 2) // 5-10% commission
  totalPrice  Decimal  @db.Decimal(10, 2)
  
  // Timeline
  deadlineAt  DateTime
  startedAt   DateTime?
  completedAt DateTime?
  
  // Status
  status      OrderStatus @default(PENDING)
  
  // Deliverables
  deliveryFiles String[] // Worker's submitted files
  deliveryNote  String?
  
  // Revision
  revisionRequested Boolean @default(false)
  revisionNote      String?
  revisionsLeft     Int
  
  // Payment & Escrow
  escrowId    String?  @unique
  escrow      Escrow?  @relation(fields: [escrowId], references: [id])
  
  // Relations
  review      Review?
  dispute     Dispute?
  messages    Message[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([clientId])
  @@index([workerId])
  @@index([status])
  @@map("orders")
}

enum OrderStatus {
  PENDING           // Menunggu worker accept
  ACCEPTED          // Worker accepted, waiting payment
  IN_PROGRESS       // Sedang dikerjakan
  DELIVERED         // Worker sudah submit
  REVISION_REQUESTED // Client minta revisi
  COMPLETED         // Selesai, dana released
  CANCELLED         // Dibatalkan
  DISPUTED          // Ada dispute
}

// ==================== ESCROW SYSTEM ====================
model Escrow {
  id            String   @id @default(uuid())
  
  // Amount
  amount        Decimal  @db.Decimal(10, 2)
  platformFee   Decimal  @db.Decimal(10, 2)
  workerAmount  Decimal  @db.Decimal(10, 2) // amount - platformFee
  
  // Status
  status        EscrowStatus @default(HELD)
  
  // Parties
  clientId      String
  workerId      String
  
  // Timestamps
  heldAt        DateTime @default(now())
  releasedAt    DateTime?
  refundedAt    DateTime?
  
  // Relations
  order         Order?
  transaction   Transaction[]
  
  @@map("escrows")
}

enum EscrowStatus {
  HELD      // Dana ditahan
  RELEASED  // Dana dilepas ke worker
  REFUNDED  // Dana dikembalikan ke client
}

// ==================== WALLET & TRANSACTIONS ====================
model Wallet {
  id          String   @id @default(uuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  balance     Decimal  @db.Decimal(10, 2) @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  transactions Transaction[]
  
  @@map("wallets")
}

model Transaction {
  id          String   @id @default(uuid())
  
  walletId    String
  wallet      Wallet   @relation(fields: [walletId], references: [id])
  
  type        TransactionType
  amount      Decimal  @db.Decimal(10, 2)
  description String
  
  // Reference
  referenceId String? // Order ID, Escrow ID, etc
  escrowId    String?
  escrow      Escrow?  @relation(fields: [escrowId], references: [id])
  
  // Metadata
  metadata    Json?    // Payment gateway response, etc
  
  status      TransactionStatus @default(PENDING)
  
  createdAt   DateTime @default(now())
  
  @@index([walletId])
  @@index([type])
  @@map("transactions")
}

enum TransactionType {
  TOP_UP        // Client top up
  ESCROW_HOLD   // Dana ditahan untuk order
  ESCROW_RELEASE // Dana dilepas ke worker
  ESCROW_REFUND // Dana dikembalikan
  WITHDRAWAL    // Worker withdraw
  PLATFORM_FEE  // Fee untuk platform
}

enum TransactionStatus {
  PENDING
  SUCCESS
  FAILED
  CANCELLED
}

// ==================== REVIEWS ====================
model Review {
  id          String   @id @default(uuid())
  
  orderId     String   @unique
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  serviceId   String
  service     Service  @relation(fields: [serviceId], references: [id])
  
  // From client to worker
  reviewerId  String
  reviewer    User     @relation("ReviewsGiven", fields: [reviewerId], references: [id])
  
  revieweeId  String
  reviewee    User     @relation("ReviewsReceived", fields: [revieweeId], references: [id])
  
  rating      Int      // 1-5
  comment     String?
  
  // Reply from worker (optional)
  reply       String?
  repliedAt   DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([serviceId])
  @@index([revieweeId])
  @@map("reviews")
}

// ==================== CHAT SYSTEM ====================
model Chat {
  id          String   @id @default(uuid())
  
  // Relations
  participants ChatParticipant[]
  messages    Message[]
  
  // Metadata
  orderId     String?  // Link to order if related
  lastMessageAt DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("chats")
}

model ChatParticipant {
  id          String   @id @default(uuid())
  
  chatId      String
  chat        Chat     @relation(fields: [chatId], references: [id], onDelete: Cascade)
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Read status
  lastReadAt  DateTime?
  unreadCount Int      @default(0)
  
  // Notifications
  isMuted     Boolean  @default(false)
  
  joinedAt    DateTime @default(now())
  
  @@unique([chatId, userId])
  @@map("chat_participants")
}

model Message {
  id          String   @id @default(uuid())
  
  chatId      String
  chat        Chat     @relation(fields: [chatId], references: [id], onDelete: Cascade)
  
  orderId     String?
  order       Order?   @relation(fields: [orderId], references: [id])
  
  senderId    String
  content     String
  
  // Attachments
  attachments String[] // URLs
  
  // Status
  isRead      Boolean  @default(false)
  isEdited    Boolean  @default(false)
  isDeleted   Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([chatId])
  @@index([senderId])
  @@map("messages")
}

// ==================== NOTIFICATIONS ====================
model Notification {
  id          String   @id @default(uuid())
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type        NotificationType
  title       String
  message     String
  
  // Link/Reference
  link        String?
  referenceId String?
  
  isRead      Boolean  @default(false)
  readAt      DateTime?
  
  createdAt   DateTime @default(now())
  
  @@index([userId, isRead])
  @@map("notifications")
}

enum NotificationType {
  ORDER_RECEIVED      // Worker: ada order baru
  ORDER_ACCEPTED      // Client: order diterima
  ORDER_DELIVERED     // Client: worker submit hasil
  ORDER_COMPLETED     // Worker: order selesai, dana released
  MESSAGE_NEW         // Ada chat baru
  REVIEW_RECEIVED     // Dapat review
  PAYMENT_SUCCESS     // Top up berhasil
  WITHDRAWAL_SUCCESS  // Withdraw berhasil
  DISPUTE_OPENED      // Ada dispute
  SYSTEM              // System notification
}

// ==================== DISPUTES ====================
model Dispute {
  id          String   @id @default(uuid())
  
  orderId     String   @unique
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  complainantId String
  complainant User     @relation(fields: [complainantId], references: [id])
  
  reason      String
  description String
  evidence    String[] // File URLs
  
  status      DisputeStatus @default(OPEN)
  resolution  String?
  
  // Admin decision
  decidedBy   String?
  decidedAt   DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("disputes")
}

enum DisputeStatus {
  OPEN          // Baru dibuka
  INVESTIGATING // Admin sedang review
  RESOLVED      // Selesai
  CLOSED        // Ditutup tanpa penyelesaian
}